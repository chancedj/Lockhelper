--[[
    This file is for dealing with handling the minimap creation and display
--]]
local addonName, _ = ...;

-- libraries
local addon = LibStub( "AceAddon-3.0" ):GetAddon( addonName );
local L     = LibStub( "AceLocale-3.0" ):GetLocale( addonName, false );

-- cache lua functions
local next, table =    -- variables
      next, table    -- lua functions

-- Get a reference to the lib
local LibQTip = LibStub( "LibQTip-1.0" )

local function emptyFunction()
end

local function populateInstanceData( header, tooltip, charList, instanceList )
    -- make sure it's not empty
    if ( next( instanceList ) == nil ) then return; end

    -- start adding the instances we have completed with any chacters
    local lineNum = tooltip:AddLine( );
    tooltip.lines[ lineNum ].is_header = true;
    tooltip:SetCell( lineNum, 1, header, nil, "CENTER" );
    for instanceName, _  in next, instanceList do
        lineNum = tooltip:AddLine( instanceName );
        
        for colNdx, charData in next, charList do
            if (LockoutDb[ charData.realmName ] ~= nil) and
               (LockoutDb[ charData.realmName ][ charData.charNdx ] ~= nil) and
               (LockoutDb[ charData.realmName ][ charData.charNdx ].instances[ instanceName ] ~= nil) then
                local data = {};
                local instances = LockoutDb[ charData.realmName ][ charData.charNdx ].instances[ instanceName ];
                local instanceDisplay = {};
                for difficulty, instanceDetails in next, instances do
                    data[ #data + 1 ] = instanceDetails.displayText;
                end -- for difficulty, instanceDetails in next, instances

                instanceDisplay.displayTT = function( data )
                                                local ttName = "loInTT" .. instanceName;
                                                local tt = LibQTip:Acquire( "LockedoutTooltip" );
                                                local tooltip = LibQTip:Acquire( ttName );
                                                
                                                local col = 2;
                                                
                                                tooltip:SetColumnLayout( 1 );
                                                tooltip:AddHeader( "Boss Name" );
                                                for difficulty, instanceData in next, instances do
                                                    local col = tooltip:AddColumn( "CENTER" );

                                                    local ln = 1;
                                                    tooltip:SetCell( ln, col, difficulty, nil, "CENTER" );
                                                    tooltip:SetLineColor( ln, 1, 1, 1, 1 );
                                                    for bossName, bossData in next, instanceData.bossData do
                                                        if( col == 2 ) then
                                                            ln = tooltip:AddLine(  );
                                                        else
                                                            ln = ln + 1;
                                                        end -- if( col == 2 )
                                                    
                                                        local status = "";
                                                        if ( bossData.isKilled ) then
                                                            status = "|cFFFF0000" .. L["Defeated"] .. "|r"; 
                                                        else
                                                            status = "|cFF00FF00" .. L["Available"] .. "|r";
                                                        end; -- if ( bossData.isKilled )

                                                        tooltip:SetCell( ln, 1, bossName, nil, "CENTER" );
                                                        tooltip:SetCell( ln, col, status, nil, "CENTER" );
                                                    end -- for bossName, bossData in next, instanceData.bossData
                                                end -- for difficulty, instanceDetails in next, instances
                                                
                                                tooltip:SmartAnchorTo( tt );
                                                tooltip:Show();
                                            end -- function( data )
                instanceDisplay.deleteTT =  function( data )
                                                local ttName = "loInTT" .. instanceName;
                                                local tooltip = LibQTip:Acquire( ttName );
                                                
                                                LibQTip:Release( tooltip );
                                            end -- function( data )

                tooltip:SetCell( lineNum, colNdx + 1, addon:colorizeString( charData.className, table.concat( data, " " ) ), nil, "CENTER" );
                tooltip:SetCellScript( lineNum, colNdx + 1, "OnEnter", function() instanceDisplay:displayTT( instances ); end );    -- open tooltip with info when entering cell.
                tooltip:SetCellScript( lineNum, colNdx + 1, "OnLeave", function() instanceDisplay:deleteTT( instances ); end );    -- close out tooltip when leaving
                tooltip:SetLineScript( lineNum, "OnEnter", emptyFunction );                -- empty function allows the background to highlight
            end -- if (LockoutDb[ charData.realmName ] ~= nil) and .....
        end -- for colNdx, charData in next, charList
    end

    tooltip:AddSeparator( );
end -- populateInstanceData

local function populateWorldBossData( header, tooltip, charList, worldBossList )
    -- make sure it's not empty
    if ( next( worldBossList ) == nil ) then return; end

    -- start adding the instances we have completed with any chacters
    local lineNum = tooltip:AddLine( );
    tooltip.lines[ lineNum ].is_header = true;
    tooltip:SetCell( lineNum, 1, header, nil, "CENTER" );
    for bossName, _ in next, worldBossList do
        lineNum = tooltip:AddLine( bossName );
        
        for colNdx, charData in next, charList do
            if (LockoutDb[ charData.realmName ] ~= nil) and
               (LockoutDb[ charData.realmName ][ charData.charNdx ] ~= nil) and
               (LockoutDb[ charData.realmName ][ charData.charNdx ].worldBosses[ bossName ] ~= nil) then
                local bossData = LockoutDb[ charData.realmName ][ charData.charNdx ].worldBosses[ bossName ];
                
                tooltip:SetCell( lineNum, colNdx + 1, bossData.displayText, nil, "CENTER" );
                tooltip:SetCellScript( lineNum, colNdx + 1, "OnEnter", emptyFunction );    -- close out tooltip when leaving
                tooltip:SetCellScript( lineNum, colNdx + 1, "OnLeave", emptyFunction );    -- open tooltip with info when entering cell.
                tooltip:SetLineScript( lineNum, "OnEnter", emptyFunction );                -- empty function allows the background to highlight
            end -- if (LockoutDb[ charData.realmName ] ~= nil) and .....
        end -- for colNdx, charData in next, charList
    end -- for bossName, _ in next, worldBossList

    tooltip:AddSeparator( );
end -- populateInstanceData

local function populateCurrencyData( header, tooltip, charList, currencyList )
    -- make sure it's not empty
    if ( next( currencyList ) == nil ) then return; end

    -- start adding the instances we have completed with any chacters
    local lineNum = tooltip:AddLine( );
    tooltip.lines[ lineNum ].is_header = true;
    tooltip:SetCell( lineNum, 1, header, nil, "CENTER" );
    for currencyName, currencyData in next, currencyList do
        if( currencyData.icon ) then
            lineNum = tooltip:AddLine( currencyData.icon .. currencyName );
        else
            lineNum = tooltip:AddLine( currencyName );
        end
        
        for colNdx, charData in next, charList do
            if (LockoutDb[ charData.realmName ] ~= nil) and
               (LockoutDb[ charData.realmName ][ charData.charNdx ] ~= nil) and
               (LockoutDb[ charData.realmName ][ charData.charNdx ].currency[ currencyName ] ~= nil) then
                local currData = LockoutDb[ charData.realmName ][ charData.charNdx ].currency[ currencyName ];
                
                local displayText = currData.displayText;
                if( currData.displayTextAddl ~= nil ) then
                    displayText = displayText .. currData.displayTextAddl;
                end
                tooltip:SetCell( lineNum, colNdx + 1, addon:colorizeString( charData.className, displayText ), nil, "CENTER" );
                tooltip:SetCellScript( lineNum, colNdx + 1, "OnEnter", emptyFunction );    -- close out tooltip when leaving
                tooltip:SetCellScript( lineNum, colNdx + 1, "OnLeave", emptyFunction );    -- open tooltip with info when entering cell.
                tooltip:SetLineScript( lineNum, "OnEnter", emptyFunction );                -- empty function allows the background to highlight
            end -- if (LockoutDb[ charData.realmName ] ~= nil) and .....
        end -- for colNdx, charData in next, charList
    end -- for currencyName, _ in next, currencyList

    tooltip:AddSeparator( );
end -- populateInstanceData

local function addColorBanding( tt )
    local resetnum = 0;
    local opacLevel;
    for i = 1, tt:GetLineCount() do
        opacLevel = 0;
        if( tt.lines[ i ].is_header ) then
            resetnum = i % 2;
            opacLevel = 0.3;
        elseif( ( i + resetnum ) % 2 == 0 ) then
            opacLevel = 0.1;
        end
        tt:SetLineColor( i, 1, 1, 1, opacLevel );
    end -- for i = 1, tt:GetLineCount()
end -- addColorBanding

function addon:ShowInfo( frame )
    if ( self.tooltip ~= nil ) then
        LibQTip:Release( self.tooltip );
        self.tooltip = nil;
    end -- if ( self.tooltip ~= nil )

    local currRealmName, _, charNdx = addon:Lockedout_GetCurrentCharData();
    local playerData = LockoutDb[ currRealmName ][ charNdx ];

    Lockedout_BuildInstanceLockout( currRealmName, charNdx, playerData );
    Lockedout_BuildWorldBoss( currRealmName, charNdx, playerData );
    Lockedout_BuildCurrentList( currRealmName, charNdx, playerData );

    -- Acquire a tooltip with 3 columns, respectively aligned to left, center and right
    local tooltip = LibQTip:Acquire( "LockedoutTooltip" );
    self.tooltip = tooltip;

    local realmCount = 0;
    local charList = {};
    local dungeonList = {};
    local raidList = {};
    local worldBossList = {};
    local currencyList = {};

    -- get list of characters and realms for the horizontal
    for realmName, characters in next, LockoutDb do
        if( not self.config.profile.general.currentRealm ) or ( currRealmName == realmName ) then
            realmCount = realmCount + 1;
            for charNdx, charData in next, characters do
                local tblNdx = #charList + 1;
                charList[ tblNdx ] = {}
                charList[ tblNdx ].charNdx = charNdx;
                charList[ tblNdx ].realmName = realmName;
                charList[ tblNdx ].charName = charData.charName;
                charList[ tblNdx ].className = charData.className;

                -- the get a list of all instances across characters for vertical
                for instanceName, details in next, charData.instances do
                    local key, data = next( details );
                    
                    if ( data.isRaid ) then
                        raidList[ instanceName ] = "set";
                    else
                        dungeonList[ instanceName ] = "set";
                    end -- if ( data.isRaid )
                end -- for instanceName, _ in next, instances
                
                charData.worldBosses = charData.worldBosses or {};
                for bossName, _ in next, charData.worldBosses do
                    worldBossList[ bossName ] = "set"
                end -- for bossName, _ in next, charData.worldBosses
                
                charData.currency = charData.currency or {};
                for currName, currData in next, charData.currency do
                    currencyList[ currName ] = currencyList[ currName ] or {};
                    currencyList[ currName ].icon = currencyList[ currName ].icon or currData.icon
                end -- for currName, _ in next, charData.currency
            end -- for charName, instances in next, characters
        end
    end -- for realmName, characters in next, LockoutDb
    
    -- sort list by realm then character
    table.sort( charList, function(l, r)
                            if (l.realmName ~= r.realmName) then
                                return l.realmName < r.realmName;
                            end
                            
                            return l.charName < r.charName;
                          end
    );
    -- sort instance list
    table.sort( dungeonList );
    table.sort( raidList );
    table.sort( worldBossList );
    table.sort( currencyList );
    
    -- initialize the column count going forward
    tooltip:SetColumnLayout( #charList + 1 );

    -- Add a header filling only the first columns in the first 2 rows (Realm, Character)
    local realmLineNum;
    local charLineNum;
    
    if( realmCount > 1 ) then -- show realm only when multiple are involved
        realmLineNum = tooltip:AddHeader( L[ "Realm" ] ); -- realm column
    end
    charLineNum  = tooltip:AddHeader( L[ "Character" ] ); -- char column
    -- add the characters and realms across the header
    for colNdx, char in next, charList do
        if( realmCount > 1 ) then -- show realm only when multiple are involved
            tooltip:SetCell( realmLineNum, colNdx + 1, addon:colorizeString( char.className, char.realmName ), nil, "CENTER" );
        end
        local charData = LockoutDb[ char.realmName ][ char.charNdx ];
        local charDisplay = {};
        charDisplay.displayTT = function( data )
                                    if ( charData.iLevel == nil ) then
                                        return;
                                    end

                                    local ttName = "loChTT" .. charData.charName;
                                    local tt = LibQTip:Acquire( "LockedoutTooltip" );
                                    local tooltip = LibQTip:Acquire( ttName );
                                    tooltip:SetColumnLayout( 2 );
                                    local line = tooltip:AddHeader( "" );
                                    tooltip:SetLineColor( line, 1, 1, 1, 1 );
                                    tooltip:SetCell( line, 1, L["Character iLevels"], 2 );
                                    for k, p in next, charData.iLevel do
                                        tooltip:AddLine( k, p );
                                    end -- for k, p in next, charData.iLevel

                                    tooltip:SmartAnchorTo( tt );
                                    tooltip:Show();
                                end -- function( data )
        charDisplay.deleteTT =  function( data )
                                    local ttName = "loChTT" .. charData.charName;
                                    local tooltip = LibQTip:Acquire( ttName );
                                    
                                    LibQTip:Release( tooltip );
                                end -- function( data )

        tooltip:SetCell( charLineNum, colNdx + 1, addon:colorizeString( char.className, char.charName ), nil, "CENTER" );
        tooltip:SetCellScript( charLineNum, colNdx + 1, "OnEnter", function() charDisplay:displayTT( charData ); end ); -- close out tooltip when leaving
        tooltip:SetCellScript( charLineNum, colNdx + 1, "OnLeave", function() charDisplay:deleteTT( charData ); end );     -- close out tooltip when leaving
    end -- for colNdx, char in next, charList

    tooltip:AddSeparator( );
    tooltip:AddSeparator( );

    if( self.config.profile.dungeon.show ) then
        populateInstanceData( L[ "Dungeon" ], tooltip, charList, dungeonList );
    end
    if( self.config.profile.raid.show ) then
        populateInstanceData( L[ "Raid" ], tooltip, charList, raidList );
    end
    if( self.config.profile.worldBoss.show ) then
        populateWorldBossData( L["World Boss"], tooltip, charList, worldBossList );
    end
    if( self.config.profile.currency.show ) then
        populateCurrencyData( L["Currency"], tooltip, charList, currencyList );
    end

    local lineNum = tooltip:AddLine( );
    tooltip:SetCell( lineNum, 1, "* " .. L["Right-click for configuration menu"], nil, "LEFT", #charList + 1 );
    tooltip:SetLineScript( lineNum, "OnEnter", emptyFunction );
    
    -- Use smart anchoring code to anchor the tooltip to our frame
    tooltip:SmartAnchorTo( frame );
    tooltip:SetAutoHideDelay( 0.25, frame );

    addColorBanding( tooltip );
    
    -- Show it, et voilà !
    tooltip:Show();
end --  addon:OnEnter
